
rules_version = '2';

service cloud.firestore {
  match /databases/(default)/documents {

    // Coleção para perfis de usuário e autenticação customizada
    match /auth_users/{userEmail} {
      // Permite que o cliente leia o documento de um usuário específico (GET)
      // Isso é necessário para o AppLayout verificar isApproved e isAdmin.
      allow get: if true;

      // Bloqueia a listagem de todos os usuários ou modificações diretas pelo cliente.
      // Registro e aprovação são feitos por Server Actions (que usam Admin SDK e ignoram estas regras).
      allow list, create, update, delete: if false;
    }

    // Coleção de nível raiz para os dados de produtos de cada usuário
    match /user_products/{userEmail} {
      // Esta regra é um placeholder, as permissões reais são na subcoleção abaixo.
      // Pode ser útil para permitir que um usuário crie/delete seu próprio documento user_products se necessário.
      // Por agora, vamos manter simples.
      allow read, write: if false; // Geralmente não se interage diretamente com este documento.
    }

    // Subcoleção onde os produtos carregados via Excel são armazenados
    match /user_products/{userEmail}/uploaded_products/{documentId} {
      // Permite LISTAR documentos na coleção (necessário para getDocs()).
      // Permite LER documentos individuais (necessário para getDoc(), ex: _metadata).
      // Permite CRIAR, ATUALIZAR, DELETAR documentos (necessário para writeBatch e setDoc).
      // Para fins de protótipo, estamos permitindo essas operações do lado do cliente.
      // {documentId} pode ser um ID de produto ou a string "_metadata".
      allow read, write, delete: if true;
    }

    // Regra de fallback para negar explicitamente acesso a quaisquer outros caminhos
    match /{path=**} {
      allow read, write: if false;
    }
  }
}
