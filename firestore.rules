rules_version = '2';

service cloud.firestore {
  match /databases/(default)/documents {

    // Coleção de perfis de autenticação de usuários
    match /auth_users/{userEmail} {
      // Permite que o cliente (AppLayout) leia o perfil de um usuário específico
      // para verificar isApproved e isAdmin após o login.
      allow get: if true;

      // Bloqueia a listagem de todos os usuários ou a modificação direta
      // de perfis de usuário pelo cliente. Estas operações (registro, aprovação)
      // são gerenciadas por Server Actions que usam o Admin SDK.
      allow list, create, update, delete: if false;
    }

    // Permite que o cliente do administrador (verificado na UI)
    // liste/consulte a coleção auth_users para encontrar usuários pendentes.
    // Esta regra é mais ampla do que o ideal se não fosse pelo filtro no cliente,
    // mas é necessária para o listener de notificações do admin com auth customizado.
    match /auth_users {
      allow list: if true; // Permite a query com 'where' e 'orderBy'
    }

    // Coleção global de produtos
    match /shared_products/{productId} {
      allow read: if true;
      allow write: if true; // For prototype admin client writes
    }
    match /shared_products {
      allow list: if true; // Para getDocs na coleção
    }

    // Metadados globais da aplicação
    match /app_metadata/products_metadata {
      allow read: if true;
      allow write: if true; // For prototype admin client writes
    }

    // Regra de fallback: nega acesso a quaisquer outros caminhos não definidos acima.
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
