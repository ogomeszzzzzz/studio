
rules_version = '2';

service cloud.firestore {
  match /databases/(default)/documents {

    // Coleção de perfis de autenticação de usuários
    match /auth_users/{userEmail} {
      // Permite que o cliente (AppLayout) leia o perfil de um usuário específico
      // para verificar isApproved e isAdmin após o login.
      allow get: if true;

      // Bloqueia a listagem de todos os usuários ou a modificação direta
      // de perfis de usuário pelo cliente. Estas operações (registro, aprovação)
      // são gerenciadas por Server Actions que usam o Admin SDK.
      allow list, create, update, delete: if false;
    }

    // Coleção global de produtos
    // Acessível para leitura por todos os usuários.
    // A escrita (upload) é feita pelo cliente do admin; a UI restringe o botão de upload.
    match /shared_products/{productId} {
      allow read: if true;
      allow write: if true; 
    }
    match /shared_products { // Necessário para listar a coleção (getDocs)
      allow list: if true;
    }


    // Documento de metadados globais para os produtos
    // Similar a shared_products: leitura para todos, escrita pelo admin via UI.
    match /app_metadata/products_metadata {
      allow read: if true;
      allow write: if true; 
    }

    // Coleção de histórico de estoque
    // Permite que o cliente leia documentos individuais.
    match /stock_history/{docId} {
      allow read: if true;
      // Criação é feita pela server action do admin, então o cliente não pode criar/atualizar/deletar.
      allow create, update, delete: if false; 
    }
    // Permite que o cliente liste/consulte a coleção 'stock_history' inteira.
    // Isto é necessário para a query com orderBy("date").
    match /stock_history {
      allow list: if true;
    }

    // Regra de fallback: nega acesso a quaisquer outros caminhos não definidos acima.
    // ESTA REGRA DEVE SER A ÚLTIMA DENTRO DE match /databases/(default)/documents { ... }
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
